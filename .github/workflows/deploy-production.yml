# =============================================================================
# GraceGiver Production Deployment
# =============================================================================
# Deploys to Synology NAS (active-server) when tests pass and changes are
# merged to main. Uses Tailscale for secure connectivity.
# =============================================================================

name: Deploy Production

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["Docker Build & Publish"]
    types: [completed]
    branches: [main]

concurrency:
  group: production-deployment
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Synology
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          tags: tag:ci

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          # Pass secrets to the remote shell
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DO_PULL: "true"
        with:
          host: brookwood.tail6e8dc.ts.net
          username: shedrick
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GH_TOKEN,DO_PULL
          # Deploy script:
          # 1. Navigate to project dir (configured via secret or default)
          # 2. Login to GHCR to pull private images
          # 3. Pull latest images
          # 4. Restart containers
          script: |
            PROJECT_PATH="${{ secrets.SYNOLOGY_PROJECT_PATH || '/volume1/docker/gracegiver' }}"
            echo "Deploying to $PROJECT_PATH..."

            cd "$PROJECT_PATH" || { echo "Project directory not found!"; exit 1; }

            # Login to GHCR (required if repo is private)
            echo "$GH_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull new images
            docker-compose pull

            # Restart containers (zero-downtime if possible, but recreating to ensure new image)
            docker-compose up -d --remove-orphans

            # Prune old images to save space
            docker image prune -f

            echo "Deployment complete!"
